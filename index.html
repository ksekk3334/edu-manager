<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>공서이곡곡 학습매니저</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+KR:wght@300;400;500;700&display=swap');
        body { font-family: 'Noto Sans KR', sans-serif; }
        
        /* Custom Scrollbar for Desktop */
        @media (min-width: 768px) {
            ::-webkit-scrollbar { width: 6px; height: 6px; }
            ::-webkit-scrollbar-track { background: #f1f1f1; }
            ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
            ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        }

        /* Hide Scrollbar for Clean Mobile UI */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Semester Toggle */
        .semester-active { background-color: #4f46e5; color: white; font-weight: 700; }
        .semester-inactive { background-color: #f3f4f6; color: #4b5563; }
        
        /* Active School Item */
        .school-item-active { background-color: #eef2ff; border-left: 4px solid #4f46e5; }
        .school-item-inactive { background-color: transparent; border-left: 4px solid transparent; }
        .school-item-inactive:hover { background-color: #f9fafb; }

        /* Mobile Backdrop */
        #mobile-backdrop { transition: opacity 0.3s ease-in-out; }

        /* Edit Mode Styles */
        .editable-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 14px;
        }
        .editable-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.2);
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 h-screen md:h-screen h-[100dvh] flex flex-col overflow-hidden" id="main-body">

    <header class="bg-indigo-900 text-white shadow-md z-30 relative" id="main-header">
        <div class="flex items-center justify-between px-4 py-3">
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                     <div class="w-8 h-8 bg-white rounded text-indigo-900 flex items-center justify-center font-bold text-xs">EDU</div>
                     <h1 class="text-xl font-bold tracking-tight hidden md:block">공서이곡곡 학습매니저</h1>
                     <h1 class="text-lg font-bold tracking-tight md:hidden">학습매니저</h1>
                </div>
            </div>
            <div class="flex items-center gap-4">
                <div class="hidden md:flex items-center gap-4 text-sm text-indigo-200">
                    <span id="date-display"></span>
                    <span class="w-px h-3 bg-indigo-700 mx-2"></span>
                    <span id="current-time"></span>
                </div>
                <button onclick="openSettings()" class="text-indigo-200 hover:text-white transition-colors" title="설정">
                    <i data-lucide="settings" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </header>

    <div class="flex flex-1 overflow-hidden relative" id="content-wrapper">
        
        <div id="mobile-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-20 hidden md:hidden transition-opacity" onclick="closeSidebar()"></div>

        <aside class="w-4/5 md:w-80 bg-white border-r border-gray-200 flex flex-col h-full z-30 absolute md:relative transform -translate-x-full md:translate-x-0 transition-transform duration-300 shadow-xl md:shadow-none" id="sidebar">
            <div class="p-4 border-b border-gray-100">
                <div class="flex justify-between items-center mb-3 md:hidden">
                    <span class="font-bold text-lg text-gray-800">학교 목록</span>
                    <button onclick="closeSidebar()" class="p-2 bg-gray-100 rounded-full text-gray-600">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div class="relative">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="school-search" placeholder="학교명 검색 또는 추가" 
                        class="w-full pl-9 pr-4 py-2 bg-gray-50 border border-gray-200 rounded-lg text-base md:text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500">
                </div>
                <div class="mt-3 flex gap-2">
                    <button class="filter-btn active px-3 py-1 text-xs rounded-full bg-indigo-100 text-indigo-700 font-medium" data-type="all">전체</button>
                    <button class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200" data-type="high">고등학교</button>
                    <button class="filter-btn px-3 py-1 text-xs rounded-full bg-gray-100 text-gray-600 hover:bg-gray-200" data-type="middle">중학교</button>
                </div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-2 space-y-1" id="school-list">
                </div>
            
            <div class="p-3 border-t border-gray-100 bg-gray-50">
                <button onclick="openAddSchoolModal()" class="w-full py-2 px-4 bg-white border border-indigo-200 text-indigo-600 rounded-lg text-sm font-medium hover:bg-indigo-50 transition flex items-center justify-center gap-2 shadow-sm">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> 직접 학교 추가하기
                </button>
            </div>
        </aside>

        <main class="flex-1 flex flex-col overflow-hidden relative w-full bg-gray-50">
            <div class="md:hidden p-4 bg-white border-b flex justify-between items-center sticky top-0 z-10 shadow-sm">
                <span class="font-bold text-lg truncate max-w-[200px]" id="mobile-header-title">학교를 선택해주세요</span>
                <button id="menu-toggle" class="p-2 rounded-md hover:bg-gray-100 active:bg-gray-200 transition-colors">
                    <i data-lucide="menu" class="w-6 h-6 text-gray-700"></i>
                </button>
            </div>

            <div id="dashboard-content" class="flex-1 overflow-y-auto p-4 md:p-8">
                <div id="active-content" class="max-w-6xl mx-auto fade-in pb-10">
                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-6 mb-6 relative overflow-hidden">
                        <div class="absolute top-0 right-0 w-32 h-32 bg-indigo-50 rounded-bl-full -mr-8 -mt-8 z-0"></div>
                        <div class="relative z-10 flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                            <div>
                                <div class="flex items-center gap-2 mb-1">
                                    <span id="school-badge" class="px-2 py-0.5 rounded text-xs font-bold bg-blue-100 text-blue-700">고등학교</span>
                                    <span class="text-gray-500 text-sm flex items-center gap-1 truncate"><i data-lucide="map-pin" class="w-3 h-3"></i> <span id="school-address-header" class="truncate max-w-[300px] md:max-w-none">주소 정보</span></span>
                                </div>
                                <h2 id="school-name" class="text-2xl md:text-3xl font-bold text-gray-900">학교 이름</h2>
                                <p id="school-desc" class="text-gray-500 mt-1 text-sm hidden md:block">꿈과 끼를 키우는 행복한 배움터</p>
                            </div>
                            <div class="flex gap-3 w-full md:w-auto">
                                <button onclick="copyLink()" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium transition">
                                    <i data-lucide="share-2" class="w-4 h-4"></i> 공유
                                </button>
                                <button id="header-map-link" class="flex-1 md:flex-none flex items-center justify-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 text-sm font-medium shadow-lg shadow-indigo-200 transition">
                                    <i data-lucide="map" class="w-4 h-4"></i> 지도
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                        
                        <div class="lg:col-span-2 space-y-6">
                            
                            <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                                <div class="p-4 border-b border-gray-100 flex items-center justify-between bg-indigo-50">
                                    <span class="text-sm font-bold text-indigo-900 flex items-center gap-2">
                                        <i data-lucide="layers" class="w-4 h-4"></i> 학년 선택
                                    </span>
                                    <div class="flex bg-white rounded-lg p-1 shadow-sm">
                                        <button class="grade-btn flex-1 px-4 py-2 md:py-1.5 text-xs font-bold rounded-md bg-indigo-600 text-white shadow-sm transition-all" data-grade="1">1학년</button>
                                        <button class="grade-btn flex-1 px-4 py-2 md:py-1.5 text-xs font-medium text-gray-500 hover:bg-gray-50 rounded-md transition-all" data-grade="2">2학년</button>
                                        <button class="grade-btn flex-1 px-4 py-2 md:py-1.5 text-xs font-medium text-gray-500 hover:bg-gray-50 rounded-md transition-all" data-grade="3">3학년</button>
                                    </div>
                                </div>

                                <div class="flex border-b border-gray-200 px-2 overflow-x-auto no-scrollbar">
                                    <button class="tab-btn active whitespace-nowrap px-4 py-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600" data-tab="overview">종합 개요</button>
                                    <button class="tab-btn whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="academic">학사일정</button>
                                    <button class="tab-btn whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="exam">교과서/시험</button>
                                    <button class="tab-btn whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="comm">소통창</button>
                                    <button class="tab-btn whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700" data-tab="dev">개발자 건의함</button>
                                </div>

                                <div class="p-4 md:p-6 min-h-[400px]">
                                    
                                    <div id="tab-overview" class="tab-content block space-y-6">
                                        <div>
                                            <h3 class="text-lg font-bold mb-3 flex items-center gap-2">
                                                <i data-lucide="megaphone" class="w-5 h-5 text-red-500"></i> <span class="current-grade-text">1학년</span> 학교 공지사항
                                            </h3>
                                            <div class="bg-white border border-gray-200 rounded-xl p-5 shadow-sm hover:shadow-md transition-shadow relative">
                                                <div class="flex flex-col md:flex-row items-center justify-between gap-4 relative z-10">
                                                    <div class="flex items-center gap-4 w-full">
                                                        <div class="w-12 h-12 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-600 flex-shrink-0">
                                                            <i data-lucide="external-link" class="w-6 h-6"></i>
                                                        </div>
                                                        <div class="flex-1">
                                                            <h4 class="font-bold text-gray-900 flex items-center gap-2">
                                                                공식 홈페이지
                                                                <button onclick="editWebsite()" class="text-xs text-gray-400 hover:text-indigo-600 p-1 bg-gray-50 rounded" title="주소 수정">
                                                                    <i data-lucide="edit-2" class="w-3 h-3"></i>
                                                                </button>
                                                            </h4>
                                                            <p class="text-xs md:text-sm text-gray-500 mt-1">가정통신문, 공지사항 등 정확한 정보 확인</p>
                                                        </div>
                                                    </div>
                                                    <button id="school-website-link" class="w-full md:w-auto px-6 py-3 bg-indigo-600 text-white text-sm font-bold rounded-lg hover:bg-indigo-700 transition-colors text-center">
                                                        바로가기
                                                    </button>
                                                </div>
                                                
                                                <div id="website-edit-form" class="hidden mt-4 pt-4 border-t border-gray-100">
                                                    <div class="flex gap-2 flex-col md:flex-row">
                                                        <input type="text" id="new-website-url" class="flex-1 p-3 border border-gray-300 rounded-lg text-sm" placeholder="https://...">
                                                        <div class="flex gap-2">
                                                            <button onclick="saveWebsite()" class="flex-1 px-4 py-2 bg-green-600 text-white rounded-lg text-sm font-bold">저장</button>
                                                            <button onclick="cancelEditWebsite()" class="flex-1 px-4 py-2 bg-gray-200 text-gray-600 rounded-lg text-sm">취소</button>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mt-6">
                                            <div class="bg-gray-50 p-4 rounded-lg">
                                                <h4 class="font-semibold text-sm text-gray-600 mb-2">최근 뉴스</h4>
                                                <div class="text-sm space-y-2 text-gray-500">
                                                    <p class="flex items-center gap-2"><i data-lucide="alert-circle" class="w-4 h-4"></i> 학교 홈페이지 알림마당을 참조하세요.</p>
                                                </div>
                                            </div>
                                            <div class="bg-gray-50 p-4 rounded-lg">
                                                <h4 class="font-semibold text-sm text-gray-600 mb-2">급식 정보 (오늘)</h4>
                                                <p class="text-sm text-gray-500 leading-relaxed">
                                                    <i data-lucide="utensils" class="w-4 h-4 inline mr-1"></i> 실제 식단은 학교 홈페이지 '급식안내' 메뉴에서 확인이 필요합니다.
                                                </p>
                                            </div>
                                        </div>
                                    </div>

                                    <div id="tab-academic" class="tab-content hidden">
                                        <div class="bg-blue-50 p-4 rounded-lg border border-blue-200 mb-6">
                                            <h4 class="font-bold text-blue-800 text-sm mb-2 flex items-center gap-2">
                                                <i data-lucide="database" class="w-4 h-4"></i> 학사일정 데이터 소스
                                            </h4>
                                            <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                                                <button onclick="openExternalLink('https://www.schoolinfo.go.kr/ei/ss/Pneiss_a01_s0.do')" class="flex items-center justify-center gap-1 p-2 bg-white border border-blue-100 rounded text-xs font-medium text-blue-600 hover:bg-blue-50">
                                                    <i data-lucide="search" class="w-3 h-3"></i> 학교알리미
                                                </button>
                                                <button onclick="fetchNeisSchedule()" class="flex items-center justify-center gap-1 p-2 bg-white border border-blue-100 rounded text-xs font-medium text-blue-600 hover:bg-blue-50">
                                                    <i data-lucide="server" class="w-3 h-3"></i> 나이스(NEIS)
                                                </button>
                                                <button id="btn-homepage-schedule" class="flex items-center justify-center gap-1 p-2 bg-white border border-blue-100 rounded text-xs font-medium text-blue-600 hover:bg-blue-50">
                                                    <i data-lucide="home" class="w-3 h-3"></i> 학교 홈페이지
                                                </button>
                                                <button onclick="searchScheduleImage()" class="flex items-center justify-center gap-1 p-2 bg-white border border-blue-100 rounded text-xs font-medium text-blue-600 hover:bg-blue-50">
                                                    <i data-lucide="image" class="w-3 h-3"></i> 일정표 이미지
                                                </button>
                                            </div>
                                            <p class="text-[10px] text-blue-500 mt-2 text-center md:text-left">
                                                * 나이스(NEIS) 불러오기는 인증키 설정 후 사용하면 더 정확합니다.
                                            </p>
                                        </div>

                                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-3 mb-4">
                                            <h3 class="text-lg font-bold flex items-center gap-2">
                                                <i data-lucide="calendar-plus" class="w-5 h-5 text-indigo-600"></i>
                                                학사일정
                                            </h3>
                                            <div class="bg-gray-100 p-1 rounded-lg flex text-xs font-medium w-full md:w-auto">
                                                <button onclick="setSemester(1)" id="sem-1-btn" class="semester-active flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center">1학기</button>
                                                <button onclick="setSemester(2)" id="sem-2-btn" class="semester-inactive flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center">2학기</button>
                                            </div>
                                        </div>
                                        
                                        <div class="bg-white p-4 rounded-xl mb-4 border border-gray-200 shadow-sm">
                                            <p class="text-xs text-gray-500 font-bold mb-2 flex items-center gap-1">
                                                <i data-lucide="edit-3" class="w-3 h-3"></i> 새 일정 직접 등록
                                            </p>
                                            <div class="flex flex-col md:flex-row gap-2">
                                                <div class="flex gap-2 w-full">
                                                    <input type="text" id="new-sched-date" placeholder="날짜 (11/25)" class="w-1/3 p-3 bg-gray-50 rounded-lg border border-gray-300 text-sm focus:outline-none">
                                                    <input type="text" id="new-sched-event" placeholder="내용 (예: 기말고사)" class="flex-1 p-3 bg-gray-50 rounded-lg border border-gray-300 text-sm focus:outline-none">
                                                </div>
                                                <button onclick="addSchedule()" class="w-full md:w-auto bg-indigo-600 text-white px-5 py-3 rounded-lg text-sm font-bold hover:bg-indigo-700">추가</button>
                                            </div>
                                        </div>

                                        <div class="relative border-l-2 border-indigo-200 ml-3 space-y-4 min-h-[300px]" id="schedule-list"></div>
                                    </div>

                                    <div id="tab-exam" class="tab-content hidden">
                                        <div class="flex justify-between items-center mb-4">
                                            <h3 class="text-lg font-bold flex items-center gap-2">
                                                <span class="current-grade-text">1학년</span> 교과서 및 시험
                                                <button onclick="searchTextbookInfo()" class="px-2 py-1 bg-indigo-50 text-indigo-600 text-[10px] rounded-md hover:bg-indigo-100 border border-indigo-100">
                                                    <i data-lucide="search" class="w-3 h-3 inline"></i> 교과서 목록 검색
                                                </button>
                                            </h3>
                                            <button id="edit-textbook-btn" onclick="toggleTextbookEditMode()" class="text-xs px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium flex items-center gap-1">
                                                <i data-lucide="settings" class="w-3 h-3"></i> 수정
                                            </button>
                                        </div>
                                        <div class="overflow-x-auto mb-4">
                                            <table class="w-full text-sm text-left text-gray-600 border border-gray-200 rounded-lg min-w-[500px]">
                                                <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b border-gray-200">
                                                    <tr>
                                                        <th class="px-4 py-2 w-1/4">과목</th>
                                                        <th class="px-4 py-2 w-1/3">출판사</th>
                                                        <th class="px-4 py-2 w-1/4">저자/비고</th>
                                                        <th class="px-4 py-2 w-24 text-center">출처/상태</th>
                                                        <th class="px-4 py-2 w-10 text-center edit-col hidden">삭제</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="textbook-table" class="bg-white"></tbody>
                                            </table>
                                        </div>
                                        <div id="add-textbook-row" class="hidden mb-6">
                                            <button onclick="addTextbookRow()" class="w-full py-3 border-2 border-dashed border-gray-300 text-gray-500 rounded-lg hover:bg-gray-50 text-sm font-medium mb-2">
                                                <i data-lucide="plus" class="w-4 h-4 inline"></i> 과목 추가하기
                                            </button>
                                            <button onclick="saveTextbooks()" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg text-sm font-bold">저장 완료</button>
                                        </div>
                                        <div class="bg-gray-50 p-3 rounded-lg text-xs text-gray-500 flex gap-4">
                                            <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-500"></div> 확인됨: 학교 공시/홈페이지 자료</span>
                                            <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-red-500"></div> 추정: 서울 주요학교 통계치</span>
                                        </div>
                                    </div>

                                    <div id="tab-comm" class="tab-content hidden">
                                        <h3 class="text-lg font-bold mb-4"><span class="current-grade-text">1학년</span> 소통창</h3>
                                        <div class="bg-gray-50 p-4 rounded-lg mb-6 border border-gray-200">
                                            <textarea id="comm-content" class="w-full p-3 border border-gray-300 rounded-lg text-base mb-3" rows="2" placeholder="자유롭게 이야기를 나누세요."></textarea>
                                            <div class="flex justify-between items-center gap-2">
                                                <input id="comm-author" type="text" placeholder="닉네임" class="p-2 border border-gray-300 rounded-lg text-sm w-32">
                                                <button onclick="addComment()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">등록</button>
                                            </div>
                                        </div>
                                        <div id="comm-list" class="space-y-4 max-h-[400px] overflow-y-auto"></div>
                                    </div>

                                    <div id="tab-dev" class="tab-content hidden">
                                        <h3 class="text-lg font-bold mb-4 flex items-center gap-2"><i data-lucide="wrench" class="w-5 h-5 text-yellow-600"></i> 개발자 건의함</h3>
                                        <div class="bg-yellow-50 p-4 rounded-lg mb-6 border border-yellow-200 flex gap-2">
                                            <input id="dev-request-input" type="text" class="flex-1 p-3 border border-yellow-300 rounded-lg text-base" placeholder="건의사항 입력">
                                            <button onclick="addDevRequest()" class="bg-yellow-500 text-white px-4 py-2 rounded-lg text-sm font-bold">전송</button>
                                        </div>
                                        <div id="dev-request-list" class="space-y-2"></div>
                                    </div>

                                </div>
                            </div>
                        </div>

                        <div class="space-y-6">
                            <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                                <h3 class="font-bold text-gray-900 mb-4">학교 기본 정보</h3>
                                <div class="space-y-4 text-sm">
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-green-100 flex items-center justify-center text-green-600"><i data-lucide="users" class="w-4 h-4"></i></div>
                                        <div><p class="text-xs text-gray-500">학생수</p><p class="font-medium" id="student-count">580명</p></div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-orange-100 flex items-center justify-center text-orange-600"><i data-lucide="bus" class="w-4 h-4"></i></div>
                                        <div><p class="text-xs text-gray-500">교통편</p><p class="font-medium" id="transport-info">-</p></div>
                                    </div>
                                    <div class="flex items-center gap-3">
                                        <div class="w-8 h-8 rounded-full bg-purple-100 flex items-center justify-center text-purple-600"><i data-lucide="phone" class="w-4 h-4"></i></div>
                                        <div><p class="text-xs text-gray-500">대표전화</p><a href="#" id="phone-link" class="font-medium text-indigo-600 underline">02-1234-5678</a></div>
                                    </div>
                                </div>
                            </div>

                            <div class="bg-gray-200 h-48 rounded-xl relative overflow-hidden group cursor-pointer">
                                <button id="sidebar-map-link" class="block w-full h-full">
                                    <div class="absolute inset-0 bg-gray-300 flex flex-col items-center justify-center text-center p-4 hover:bg-gray-200 transition-colors">
                                        <i data-lucide="map-pin" class="w-8 h-8 text-red-500 mb-2"></i>
                                        <p class="font-bold text-gray-700 text-sm truncate w-full px-4" id="map-address-text">주소 로딩중...</p>
                                        <span class="text-xs text-gray-500 mt-1">클릭하여 구글 지도 열기</span>
                                    </div>
                                </button>
                            </div>

                            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                                <div class="flex items-center justify-between mb-4">
                                    <h3 class="text-lg font-bold flex items-center gap-2 text-indigo-900">
                                        <i data-lucide="newspaper" class="w-5 h-5 text-indigo-600"></i>
                                        교육 핫이슈 키워드
                                    </h3>
                                </div>
                                <span class="text-[10px] text-gray-400 block mb-3 text-right" id="news-date"></span>
                                <div id="news-list" class="min-h-[120px]">
                                    </div>
                                <div class="mt-4 p-2 bg-gray-50 text-[10px] text-gray-400 rounded text-center">
                                    키워드 클릭 시 베리타스알파 검색 결과로 이동합니다.
                                </div>
                            </div>
                            
                        </div>

                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="settings-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center fade-in px-4">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-lg text-gray-900">환경 설정</h3>
                <button onclick="closeSettings()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-1">나이스(NEIS) API 인증키</label>
                    <input type="password" id="neis-api-key" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500" placeholder="인증키 입력 (선택사항)">
                    <p class="text-xs text-gray-400 mt-1">미입력 시 공용 키가 사용되지만 트래픽 제한이 있을 수 있습니다.</p>
                </div>
            </div>
            <div class="mt-6 flex justify-end">
                <button onclick="saveSettings()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg text-sm font-bold">저장</button>
            </div>
        </div>
    </div>

    <div id="toast-container" class="fixed bottom-4 right-4 flex flex-col gap-2 z-50"></div>

    <div id="confirm-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center fade-in px-4">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-sm w-full">
            <div class="flex items-center gap-3 mb-4">
                <div class="w-10 h-10 rounded-full bg-red-100 flex items-center justify-center text-red-600"><i data-lucide="trash-2" class="w-5 h-5"></i></div>
                <h3 class="font-bold text-lg text-gray-900">삭제 확인</h3>
            </div>
            <p class="text-gray-600 mb-6 text-sm">정말로 삭제하시겠습니까? 복구할 수 없습니다.</p>
            <div class="flex justify-end gap-2">
                <button onclick="closeConfirmModal()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 font-medium text-sm">취소</button>
                <button id="confirm-delete-btn" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 font-medium text-sm shadow-sm">삭제하기</button>
            </div>
        </div>
    </div>

    <div id="add-school-modal" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center fade-in px-4">
        <div class="bg-white p-6 rounded-xl shadow-xl max-w-md w-full">
            <div class="flex items-center justify-between mb-4">
                <h3 class="font-bold text-xl text-gray-900 flex items-center gap-2">
                    <i data-lucide="school" class="w-6 h-6 text-indigo-600"></i> 학교 직접 추가
                </h3>
                <button onclick="closeAddSchoolModal()" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">학교명 <span class="text-red-500">*</span></label>
                    <input type="text" id="add-school-name" oninput="handleSchoolNameInput(this.value)" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="예: 상암고등학교">
                    <p id="auto-fill-msg" class="text-xs text-indigo-600 mt-1 hidden"><i data-lucide="sparkles" class="w-3 h-3 inline"></i> 자동으로 정보를 찾았습니다!</p>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">구분</label>
                    <div class="flex gap-2">
                        <button type="button" onclick="selectAddType('middle')" id="btn-type-middle" class="flex-1 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-500 text-indigo-700 font-bold">중학교</button>
                        <button type="button" onclick="selectAddType('high')" id="btn-type-high" class="flex-1 py-2 border rounded-lg text-sm border-gray-300 text-gray-600 hover:bg-gray-50">고등학교</button>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">주소 (선택)</label>
                    <input type="text" id="add-school-addr" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="예: 서울특별시 마포구...">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">홈페이지 (선택)</label>
                    <input type="text" id="add-school-web" class="w-full p-3 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 focus:outline-none" placeholder="https://...">
                </div>
            </div>
            <div class="mt-6">
                <button onclick="submitAddSchool()" class="w-full py-3 bg-indigo-600 text-white rounded-lg font-bold text-sm hover:bg-indigo-700 shadow-md transition-transform active:scale-95">
                    등록하기
                </button>
            </div>
        </div>
    </div>

    <script>
        // Default Schools Data
        const defaultSchools = [
            { id: 'gajaewul', name: '가재울중학교', type: 'middle', students: '850명', transport: '경의중앙 가좌역', phone: '02-304-0070', website: 'http://gajaeul.sen.ms.kr', address: '서울특별시 서대문구 수색로 100-75' },
            { id: 'gyeongseong_h', name: '경성고등학교', type: 'high', students: '720명', transport: '홍대입구역', phone: '02-335-2621', website: 'http://gyeongseong.sen.hs.kr', address: '서울특별시 마포구 성미산로 111' },
            { id: 'gyeongseong_m', name: '경성중학교', type: 'middle', students: '450명', transport: '홍대입구역', phone: '02-334-9171', website: 'http://gyeongseong.sen.ms.kr', address: '서울특별시 마포구 성미산로 111' },
            { id: 'gwangseong', name: '광성고등학교', type: 'high', students: '800명', transport: '대흥역', phone: '02-713-6321', website: 'http://kwangsung.sen.hs.kr', address: '서울특별시 마포구 신수로8길 20' },
            { id: 'duksung', name: '덕성여자고등학교', type: 'high', students: '650명', transport: '안국역', phone: '02-720-2161', website: 'http://duksung.sen.hs.kr', address: '서울특별시 종로구 율곡로3길 50' },
            { id: 'dongdo', name: '동도중학교', type: 'middle', students: '600명', transport: '대흥역', phone: '02-715-2365', website: 'http://dong-do.sen.ms.kr', address: '서울특별시 마포구 백범로25길 41' },
            { id: 'seoul_w_m', name: '서울여자중학교', type: 'middle', students: '500명', transport: '마포구청역', phone: '02-715-6261', website: 'http://seoul.sen.ms.kr', address: '서울특별시 마포구 백범로25길 34' },
            { id: 'soongmoon', name: '숭문중학교', type: 'middle', students: '480명', transport: '대흥역', phone: '02-716-2971', website: 'http://soongmoon.sen.ms.kr', address: '서울특별시 마포구 숭문길 99' },
            { id: 'sindorim', name: '신도림중학교', type: 'middle', students: '900명', transport: '신도림역', phone: '02-2633-7011', website: 'http://sindorim.sen.ms.kr', address: '서울특별시 구로구 경인로63길 74' },
            { id: 'ahyeon', name: '아현중학교', type: 'middle', students: '400명', transport: '아현역', phone: '02-362-6731', website: 'http://ahyeon.sen.ms.kr', address: '서울특별시 마포구 마포대로 247' },
            { id: 'ewha_h', name: '이대부속고등학교', type: 'high', students: '1,100명', transport: '이대역', phone: '02-362-2246', website: 'http://edaebugo.sen.hs.kr', address: '서울특별시 서대문구 성산로 560' },
            { id: 'ewha_m', name: '이대부속중학교', type: 'middle', students: '550명', transport: '이대역', phone: '02-362-2242', website: 'http://ewha.sen.ms.kr', address: '서울특별시 서대문구 성산로 560' },
            { id: 'inchang', name: '인창고등학교', type: 'high', students: '680명', transport: '서대문역', phone: '02-363-0161', website: 'http://inchang.sen.hs.kr', address: '서울특별시 서대문구 경기대로 65' },
            { id: 'jungang_h', name: '중앙여자고등학교', type: 'high', students: '700명', transport: '홍제역', phone: '02-362-3061', website: 'http://jungang.sen.hs.kr', address: '서울특별시 서대문구 북아현로11가길 7' },
            { id: 'jungang_m', name: '중앙여자중학교', type: 'middle', students: '450명', transport: '홍제역', phone: '02-362-3062', website: 'http://jungang.sen.ms.kr', address: '서울특별시 서대문구 북아현로11가길 7' },
            { id: 'changcheon', name: '창천중학교', type: 'middle', students: '350명', transport: '신촌역', phone: '02-701-0071', website: 'http://changcheon.sen.ms.kr', address: '서울특별시 마포구 백범로1길 56' },
            { id: 'hanseong', name: '한국한성화교중', type: 'middle', students: '200명', transport: '연희동', phone: '02-335-7027', website: 'http://hanxiao.or.kr', address: '서울특별시 서대문구 연희로 176' },
        ];

        // Auto-fill Database (Expanded)
        const autoFillDB = {
            '배문고': { type: 'high', address: '서울특별시 용산구 효창원로 258', website: 'http://www.baemoon.hs.kr', phone: '02-3480-7100' },
            '한성고': { type: 'high', address: '서울특별시 서대문구 북아현로1길 24', website: 'http://hanseong.sen.hs.kr', phone: '02-363-4943' },
            '숭실고': { type: 'high', address: '서울특별시 은평구 은평터널로7길 6', website: 'http://soongsil.sen.hs.kr', phone: '02-373-5910' },
            '용산고': { type: 'high', address: '서울특별시 용산구 두텁바위로 60', website: 'http://yongsan.sen.hs.kr', phone: '02-3706-6700' },
            '이화여고': { type: 'high', address: '서울특별시 중구 정동길 26', website: 'http://www.ewha.hs.kr', phone: '02-752-3353' },
            '배화여고': { type: 'high', address: '서울특별시 종로구 필운대로1길 34', website: 'http://paiwha.sen.hs.kr', phone: '02-724-0300' },
            '대신고': { type: 'high', address: '서울특별시 종로구 사직로 9', website: 'http://daeshin.sen.hs.kr', phone: '02-736-0317' },
            '명지고': { type: 'high', address: '서울특별시 서대문구 명지2길 56', website: 'http://myongji.sen.hs.kr', phone: '02-303-1540' },
            '충암고': { type: 'high', address: '서울특별시 은평구 가좌로5길 5', website: 'http://cham.sen.hs.kr', phone: '02-309-0236' },
            '가재울고': { type: 'high', address: '서울특별시 서대문구 수색로 100-35', website: 'http://gajaeul.sen.hs.kr', phone: '02-6351-0500' },
            '상암고': { type: 'high', address: '서울특별시 마포구 월드컵북로 445', website: 'http://sangam.sen.hs.kr', phone: '02-373-0041' },
            '홍익여고': { type: 'high', address: '서울특별시 마포구 성미산로 51', website: 'http://hongik.sen.hs.kr', phone: '02-331-7584' },
            '홍익디자인고': { type: 'high', address: '서울특별시 마포구 성미산로 111', website: 'http://hongik.sen.sc.kr', phone: '02-3140-1330' }
        };

        // Verified 2025 Textbook Data (Specific Schools)
        const textbookDataSeed = {
            'soongmoon': {
                 '1': [ 
                    { subject: '국어', pub: '비상(박현숙)', author: '박현숙', status: 'confirmed' }, 
                    { subject: '수학', pub: '비상(이진호)', author: '이진호', status: 'confirmed' }, 
                    { subject: '사회', pub: '비상(강창숙)', author: '강창숙', status: 'confirmed' }, 
                    { subject: '과학', pub: '비상(임태훈)', author: '임태훈', status: 'confirmed' },
                    { subject: '도덕', pub: '비상(김국현)', author: '김국현', status: 'confirmed' },
                    { subject: '체육', pub: '동아(최의창)', author: '최의창', status: 'confirmed' },
                    { subject: '미술', pub: '미래엔(노현옥)', author: '노현옥', status: 'confirmed' }
                ]
            },
            'gajaewul': { 
                 '1': [ 
                    { subject: '국어', pub: '비상(박현숙)', author: '박현숙', status: 'confirmed' }, 
                    { subject: '수학', pub: '비상(이진호)', author: '이진호', status: 'confirmed' }, 
                    { subject: '사회', pub: '비상(강창숙)', author: '강창숙', status: 'confirmed' }, 
                    { subject: '도덕', pub: '비상(김국현)', author: '김국현', status: 'confirmed' }
                ]
            },
            // General Fallback
            'middle': {
                '1': [ { subject: '국어', pub: '비상(박현숙)', author: '박현숙', status: 'estimated' }, { subject: '수학', pub: '비상(이진호)', author: '이진호', status: 'estimated' }, { subject: '영어', pub: '동아(윤정미)', author: '윤정미', status: 'estimated' }, { subject: '사회', pub: '비상(강창숙)', author: '강창숙', status: 'estimated' }, { subject: '과학', pub: '비상(임태훈)', author: '임태훈', status: 'estimated' } ],
                '2': [ { subject: '국어', pub: '천재(박영목)', author: '박영목', status: 'estimated' }, { subject: '수학', pub: '비상(김원경)', author: '김원경', status: 'estimated' }, { subject: '영어', pub: '동아(윤정미)', author: '윤정미', status: 'estimated' }, { subject: '역사', pub: '미래엔(김태웅)', author: '김태웅', status: 'estimated' }, { subject: '과학', pub: '미래엔(김성진)', author: '김성진', status: 'estimated' } ],
                '3': [ { subject: '국어', pub: '천재(박영목)', author: '박영목', status: 'estimated' }, { subject: '수학', pub: '비상(김원경)', author: '김원경', status: 'estimated' }, { subject: '영어', pub: '동아(윤정미)', author: '윤정미', status: 'estimated' }, { subject: '역사', pub: '비상(도면회)', author: '도면회', status: 'estimated' }, { subject: '과학', pub: '비상(임태훈)', author: '임태훈', status: 'estimated' } ]
            },
            'high': {
                '1': [ { subject: '공통국어', pub: '비상(박영민)', author: '박영민', status: 'estimated' }, { subject: '공통수학', pub: '비상(김원경)', author: '김원경', status: 'estimated' }, { subject: '영어', pub: '천재(이재영)', author: '이재영', status: 'estimated' }, { subject: '통합사회', pub: '비상(이영호)', author: '이영호', status: 'estimated' }, { subject: '통합과학', pub: '비상(심규철)', author: '심규철', status: 'estimated' } ],
                '2': [ { subject: '문학', pub: '비상(한철우)', author: '한철우', status: 'estimated' }, { subject: '수학I', pub: '미래엔(황선욱)', author: '황선욱', status: 'estimated' }, { subject: '영어I', pub: '능률(김성곤)', author: '김성곤', status: 'estimated' }, { subject: '세계지리', pub: '비상(최병천)', author: '최병천', status: 'estimated' } ],
                '3': [ { subject: '화법과작문', pub: '비상(박영민)', author: '박영민', status: 'estimated' }, { subject: '미적분', pub: '미래엔(황선욱)', author: '황선욱', status: 'estimated' }, { subject: '영어독해', pub: '비상(김진완)', author: '김진완', status: 'estimated' } ]
            }
        };
        
        const schoolExamSchedules = { 'default': { sem1: [], sem2: [] } };

        // Persistence Service
        const DataService = {
            getSchedule: function(schoolId, grade) {
                const key = `schedule_${schoolId}_${grade}`;
                const stored = localStorage.getItem(key);
                if (stored) return JSON.parse(stored);
                return { sem1: [], sem2: [] };
            },
            saveSchedule: function(schoolId, grade, data) {
                localStorage.setItem(`schedule_${schoolId}_${grade}`, JSON.stringify(data));
            },
            getTextbooks: function(schoolType, grade, schoolId) {
                const key = `textbook_${schoolId || schoolType}_${grade}`;
                const stored = localStorage.getItem(key);
                if (stored) return JSON.parse(stored);
                
                let seedData = [];
                if (schoolId && textbookDataSeed[schoolId] && textbookDataSeed[schoolId][grade]) {
                     seedData = textbookDataSeed[schoolId][grade];
                } else {
                     seedData = textbookDataSeed[schoolType][grade] || [];
                }
                
                localStorage.setItem(key, JSON.stringify(seedData));
                return seedData;
            },
            saveTextbooks: function(schoolType, grade, data, schoolId) {
                const key = `textbook_${schoolId || schoolType}_${grade}`;
                localStorage.setItem(key, JSON.stringify(data));
            },
            getComments: function(schoolId, grade) {
                const stored = localStorage.getItem(`comm_${schoolId}_${grade}`);
                return stored ? JSON.parse(stored) : [];
            },
            addComment: function(schoolId, grade, comment) {
                const list = this.getComments(schoolId, grade);
                list.unshift(comment);
                localStorage.setItem(`comm_${schoolId}_${grade}`, JSON.stringify(list));
                return list;
            },
            getDevRequests: function() {
                const stored = localStorage.getItem('dev_requests');
                return stored ? JSON.parse(stored) : [];
            },
            addDevRequest: function(req) {
                const list = this.getDevRequests();
                list.unshift(req);
                localStorage.setItem('dev_requests', JSON.stringify(list));
                return list;
            },
            getWebsite: function(schoolId) {
                return localStorage.getItem(`website_${schoolId}`);
            },
            saveWebsite: function(schoolId, url) {
                localStorage.setItem(`website_${schoolId}`, url);
            },
            getCustomSchools: function() {
                const stored = localStorage.getItem('custom_schools');
                return stored ? JSON.parse(stored) : [];
            },
            addCustomSchool: function(school) {
                const list = this.getCustomSchools();
                list.push(school);
                localStorage.setItem('custom_schools', JSON.stringify(list));
                return list;
            },
            getNeisKey: function() { return localStorage.getItem('neis_key') || ''; },
            saveNeisKey: function(key) { localStorage.setItem('neis_key', key); }
        };

        // Helper to merge default and custom schools
        function getAllSchools() {
            const custom = DataService.getCustomSchools();
            return [...defaultSchools, ...custom];
        }

        // State
        let currentFilter = 'all';
        let activeSchoolId = defaultSchools[0].id;
        let activeSchoolType = defaultSchools[0].type;
        let currentGrade = 1;
        let currentSemester = 2;
        let isTextbookEditMode = false;
        let deleteTarget = null;
        let addSchoolType = 'middle'; 
        let autoFillData = null;

        // Elements
        const schoolListEl = document.getElementById('school-list');
        const searchInput = document.getElementById('school-search');
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('mobile-backdrop');
        const mobileMenuBtn = document.getElementById('menu-toggle');
        const currentTimeEl = document.getElementById('current-time'); 
        const gradeBtns = document.querySelectorAll('.grade-btn');
        const modal = document.getElementById('confirm-modal');
        const addSchoolModal = document.getElementById('add-school-modal');
        const settingsModal = document.getElementById('settings-modal');

        // Sidebar Logic
        function closeSidebar() { sidebar.classList.add('-translate-x-full'); backdrop.classList.add('hidden'); }
        function openSidebar() { sidebar.classList.remove('-translate-x-full'); backdrop.classList.remove('hidden'); }
        mobileMenuBtn.addEventListener('click', openSidebar);

        function openExternalLink(url) {
            if (!url) return;
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        function searchTextbookInfo() {
             const schoolName = document.getElementById('school-name').textContent;
             const query = schoolName + ' 2025학년도 교과서 목록';
             openExternalLink('https://www.google.com/search?q=' + encodeURIComponent(query));
        }
        
        function searchScheduleImage() {
             const schoolName = document.getElementById('school-name').textContent;
             const query = schoolName + ' 2025학년도 학사일정표';
             openExternalLink('https://www.google.com/search?tbm=isch&q=' + encodeURIComponent(query));
        }
        
        // Neis Logic (Using AllOrigins Proxy)
        async function fetchNeisSchedule() {
            const apiKey = DataService.getNeisKey();
            const key = apiKey || ''; 
            
            const schoolName = document.getElementById('school-name').textContent;
            
            showToast("데이터를 검색 중입니다... (Proxy 사용)");

            try {
                // Step 1: Find School Code
                const schoolUrl = `https://open.neis.go.kr/hub/schoolInfo?KEY=${key}&Type=json&SCHUL_NM=${encodeURIComponent(schoolName)}&pIndex=1&pSize=5`;
                const proxySchoolUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(schoolUrl)}`;

                const response = await fetch(proxySchoolUrl);
                const data = await response.json();
                
                if(data.schoolInfo) {
                    const row = data.schoolInfo[1].row[0];
                    const officeCode = row.ATPT_OFCDC_SC_CODE;
                    const schoolCode = row.SD_SCHUL_CODE;
                    
                    const now = new Date();
                    const yyyyMM = now.getFullYear().toString() + (now.getMonth() + 1).toString().padStart(2, '0');
                    
                    // Step 2: Fetch Schedule
                    const schedUrl = `https://open.neis.go.kr/hub/SchoolSchedule?KEY=${key}&Type=json&ATPT_OFCDC_SC_CODE=${officeCode}&SD_SCHUL_CODE=${schoolCode}&AA_YMD=${yyyyMM}`;
                    const proxySchedUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(schedUrl)}`;
                    
                    const schedResponse = await fetch(proxySchedUrl);
                    const schedData = await schedResponse.json();
                    
                    if (schedData.SchoolSchedule) {
                         const rows = schedData.SchoolSchedule[1].row;
                         const newEvents = rows.map(r => {
                            const dateStr = r.AA_YMD; 
                            const month = parseInt(dateStr.substring(4, 6));
                            const day = parseInt(dateStr.substring(6, 8));
                            return {
                                date: `${month}/${day}`,
                                event: r.EVENT_NM
                            };
                        });
                        
                        const currentMonth = now.getMonth() + 1;
                        const targetSem = (currentMonth >= 3 && currentMonth <= 7) ? 1 : 2;
                        const fullSchedule = DataService.getSchedule(activeSchoolId, currentGrade);
                        
                        // Merge and deduplicate logic roughly applied
                        if (targetSem === 1) {
                            fullSchedule.sem1 = [...fullSchedule.sem1, ...newEvents];
                            const dateValue = (d) => { const parts = d.date.split('~')[0].trim().replace(/<[^>]*>/g, '').split('/'); return parseInt(parts[0]) * 100 + parseInt(parts[1]); };
                            fullSchedule.sem1.sort((a,b) => dateValue(a) - dateValue(b));
                        } else {
                            fullSchedule.sem2 = [...fullSchedule.sem2, ...newEvents];
                            const dateValue = (d) => { const parts = d.date.split('~')[0].trim().replace(/<[^>]*>/g, '').split('/'); return parseInt(parts[0]) * 100 + parseInt(parts[1]); };
                            fullSchedule.sem2.sort((a,b) => dateValue(a) - dateValue(b));
                        }
                        
                        DataService.saveSchedule(activeSchoolId, currentGrade, fullSchedule);
                        renderScheduleList();
                        showToast(`나이스에서 ${newEvents.length}개의 일정을 불러왔습니다.`);
                    } else {
                        showToast("해당 월의 학사일정 정보가 없습니다.");
                    }
                } else {
                    showToast("학교 정보를 찾을 수 없습니다. (정확한 학교명 필요)");
                }
            } catch (e) {
                console.error(e);
                showToast("데이터 불러오기 실패 (네트워크 또는 API 키 확인)");
            }
        }

        // Render School List
        function renderSchoolList() {
            schoolListEl.innerHTML = '';
            const query = searchInput.value.toLowerCase();
            const allSchools = getAllSchools();
            
            const filtered = allSchools.filter(school => {
                const matchType = currentFilter === 'all' || school.type === currentFilter;
                const matchSearch = school.name.toLowerCase().includes(query);
                return matchType && matchSearch;
            });

            if (filtered.length === 0 && query) {
                schoolListEl.innerHTML = `
                    <div class="p-4 text-center">
                        <p class="text-sm text-gray-500 mb-3">'${query}' 검색 결과가 없습니다.</p>
                        <button onclick="openAddSchoolModal('${query}')" class="w-full py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-bold border border-indigo-100 hover:bg-indigo-100">
                            '${query}' 직접 추가하기
                        </button>
                    </div>
                `;
            } else {
                filtered.forEach(school => {
                    const isActive = school.id === activeSchoolId;
                    const item = document.createElement('button');
                    item.className = `w-full text-left p-3 rounded-lg transition mb-1 flex items-center justify-between group ${isActive ? 'school-item-active' : 'school-item-inactive'}`;
                    item.onclick = () => loadSchool(school.id);
                    item.innerHTML = `
                        <div class="overflow-hidden">
                            <div class="font-medium text-sm ${isActive ? 'text-indigo-700' : 'text-gray-700'} truncate">${school.name}</div>
                            <div class="text-xs text-gray-400 truncate max-w-[200px]">${school.address || '주소 미입력'}</div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ${isActive ? 'text-indigo-500' : 'group-hover:text-gray-400'} flex-shrink-0"></i>
                    `;
                    schoolListEl.appendChild(item);
                });
            }
            lucide.createIcons();
        }

        function loadSchool(id) {
            activeSchoolId = id;
            const allSchools = getAllSchools();
            const data = allSchools.find(s => s.id === id);
            if(!data) return;
            activeSchoolType = data.type;
            renderSchoolList();

            document.getElementById('school-name').textContent = data.name;
            document.getElementById('school-badge').textContent = data.type === 'high' ? '고등학교' : '중학교';
            document.getElementById('school-badge').className = `px-2 py-0.5 rounded text-xs font-bold ${data.type === 'high' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`;
            document.getElementById('student-count').textContent = data.students || '정보 없음';
            document.getElementById('transport-info').textContent = data.transport || '-';
            document.getElementById('phone-link').textContent = data.phone || '-';
            document.getElementById('phone-link').href = data.phone ? `tel:${data.phone}` : '#';
            
            const userUrl = DataService.getWebsite(activeSchoolId);
            const finalUrl = userUrl || data.website;
            
            const addr = data.address || '주소 정보가 없습니다';
            const mapQuery = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
            
            const mapHandler = (e) => { e.preventDefault(); openExternalLink(mapQuery); };
            document.getElementById('header-map-link').onclick = mapHandler;
            document.getElementById('sidebar-map-link').onclick = mapHandler;
            
            document.getElementById('school-address-header').textContent = addr;
            document.getElementById('map-address-text').textContent = addr;

            if(window.innerWidth < 768) closeSidebar();

            updateGradeUI(1);
            currentSemester = 2;
            updateSemesterUI();
            isTextbookEditMode = false;
            updateTextbookEditUI();
            
            const webHandler = (e) => { e.preventDefault(); openExternalLink(finalUrl); };
            document.getElementById('school-website-link').onclick = webHandler;
            document.getElementById('website-edit-form').classList.add('hidden');

            // Update link in academic tab
            document.getElementById('btn-homepage-schedule').onclick = webHandler;

            renderGradeContent(data);
            document.getElementById('mobile-header-title').textContent = data.name;
        }

        function renderGradeContent(data) {
            document.querySelectorAll('.current-grade-text').forEach(el => el.textContent = `${currentGrade}학년`);
            renderScheduleList();
            renderTextbookTable();
            renderCommList();
            renderDevRequests();
            renderNewsList();
            lucide.createIcons();
        }

        // --- Settings Modal ---
        function openSettings() {
            document.getElementById('neis-api-key').value = DataService.getNeisKey();
            settingsModal.classList.remove('hidden');
        }
        function closeSettings() { settingsModal.classList.add('hidden'); }
        function saveSettings() {
            const key = document.getElementById('neis-api-key').value;
            DataService.saveNeisKey(key);
            showToast("설정이 저장되었습니다.");
            closeSettings();
        }

        // --- Add School Modal Logic ---
        function openAddSchoolModal(prefillName = '') {
            document.getElementById('add-school-name').value = prefillName;
            document.getElementById('add-school-addr').value = '';
            document.getElementById('add-school-web').value = '';
            document.getElementById('auto-fill-msg').classList.add('hidden');
            autoFillData = null;
            if(prefillName) handleSchoolNameInput(prefillName);
            addSchoolType = 'middle'; 
            selectAddType('middle');
            addSchoolModal.classList.remove('hidden');
        }
        function closeAddSchoolModal() { addSchoolModal.classList.add('hidden'); }

        function handleSchoolNameInput(val) {
            const trimmed = val.trim();
            let foundKey = Object.keys(autoFillDB).find(key => trimmed.includes(key));
            if (foundKey) {
                const info = autoFillDB[foundKey];
                document.getElementById('add-school-addr').value = info.address;
                document.getElementById('add-school-web').value = info.website;
                selectAddType(info.type);
                document.getElementById('auto-fill-msg').classList.remove('hidden');
                autoFillData = info;
            } else {
                document.getElementById('auto-fill-msg').classList.add('hidden');
                autoFillData = null;
            }
        }

        function selectAddType(type) {
            addSchoolType = type;
            const btnMid = document.getElementById('btn-type-middle');
            const btnHigh = document.getElementById('btn-type-high');
            if(type === 'middle') {
                btnMid.className = "flex-1 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-500 text-indigo-700 font-bold";
                btnHigh.className = "flex-1 py-2 border rounded-lg text-sm border-gray-300 text-gray-600 hover:bg-gray-50";
            } else {
                btnHigh.className = "flex-1 py-2 border rounded-lg text-sm bg-blue-50 border-blue-500 text-blue-700 font-bold";
                btnMid.className = "flex-1 py-2 border rounded-lg text-sm border-gray-300 text-gray-600 hover:bg-gray-50";
            }
        }
        
        function submitAddSchool() {
            const name = document.getElementById('add-school-name').value.trim();
            const addr = document.getElementById('add-school-addr').value.trim();
            const web = document.getElementById('add-school-web').value.trim();
            
            if(!name) return showToast("학교명을 입력해주세요.");
            
            const newSchool = {
                id: `custom_${Date.now()}`,
                name: name,
                type: addSchoolType,
                address: addr || '주소 미입력',
                website: web || '',
                students: '정보 없음',
                transport: '-',
                phone: autoFillData ? autoFillData.phone : '-'
            };
            
            DataService.addCustomSchool(newSchool);
            closeAddSchoolModal();
            showToast("학교가 추가되었습니다.");
            document.getElementById('school-search').value = '';
            renderSchoolList();
            loadSchool(newSchool.id);
        }

        // Website Edit Logic
        function editWebsite() {
            const currentUrl = DataService.getWebsite(activeSchoolId) || getAllSchools().find(s => s.id === activeSchoolId)?.website;
            document.getElementById('new-website-url').value = currentUrl || '';
            document.getElementById('website-edit-form').classList.remove('hidden');
        }
        function cancelEditWebsite() { document.getElementById('website-edit-form').classList.add('hidden'); }
        function saveWebsite() {
            const newUrl = document.getElementById('new-website-url').value;
            if(newUrl) {
                DataService.saveWebsite(activeSchoolId, newUrl);
                document.getElementById('school-website-link').onclick = (e) => { e.preventDefault(); openExternalLink(newUrl); };
                showToast("홈페이지 주소가 수정되었습니다.");
                cancelEditWebsite();
            }
        }

        // News Logic - Keywords
        function renderNewsList() {
            const newsEl = document.getElementById('news-list');
            document.getElementById('news-date').textContent = new Date().toLocaleDateString() + " 기준";
            
            const keywords = [
                { word: "2028 대입 개편", query: "2028 대입 개편" },
                { word: "의대 증원", query: "의대 증원" },
                { word: "고교학점제", query: "고교학점제" },
                { word: "수능 킬러문항", query: "수능 킬러문항" },
                { word: "특목고/자사고", query: "특목고 자사고" },
                { word: "2026 수시", query: "2026 수시" },
                { word: "디지털 교과서", query: "디지털 교과서" }
            ];

            newsEl.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    ${keywords.map(k => `
                        <button onclick="openExternalLink('http://www.veritas-a.com/news/articleList.html?sc_word=${encodeURIComponent(k.query)}')" 
                            class="px-3 py-1.5 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full border border-indigo-100 hover:bg-indigo-100 hover:border-indigo-300 transition-colors">
                            #${k.word}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // Schedule Logic
        function renderScheduleList() {
            const fullSchedule = DataService.getSchedule(activeSchoolId, currentGrade);
            const activeSchedule = currentSemester === 1 ? fullSchedule.sem1 : fullSchedule.sem2;
            document.getElementById('schedule-list').innerHTML = activeSchedule.map((s, index) => `
                <div class="relative pl-6 fade-in group flex justify-between items-start">
                    <div class="absolute left-[-5px] top-1 w-2.5 h-2.5 bg-indigo-600 rounded-full border-2 border-white"></div>
                    <div><p class="text-xs font-bold text-indigo-600">${s.date}</p><p class="text-sm text-gray-800">${s.event}</p></div>
                    <button onclick="openConfirmModal('schedule', ${index})" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm italic ml-4">등록된 일정이 없습니다.</p>';
            lucide.createIcons();
        }
        function addSchedule() {
            const dateInput = document.getElementById('new-sched-date');
            const eventInput = document.getElementById('new-sched-event');
            if (!dateInput.value || !eventInput.value) return showToast("내용을 입력하세요.");
            const fullSchedule = DataService.getSchedule(activeSchoolId, currentGrade);
            const newItem = { date: dateInput.value, event: eventInput.value };
            if (currentSemester === 1) fullSchedule.sem1.push(newItem); else fullSchedule.sem2.push(newItem);
            
            const dateValue = (d) => { const parts = d.date.split('~')[0].trim().replace(/<[^>]*>/g, '').split('/'); return parseInt(parts[0]) * 100 + parseInt(parts[1]); };
            if(currentSemester === 1) fullSchedule.sem1.sort((a,b) => dateValue(a) - dateValue(b)); else fullSchedule.sem2.sort((a,b) => dateValue(a) - dateValue(b));
            
            DataService.saveSchedule(activeSchoolId, currentGrade, fullSchedule);
            renderScheduleList();
            dateInput.value = ''; eventInput.value = '';
            showToast("추가되었습니다.");
        }

        // Textbook Logic (Enhanced)
        function renderTextbookTable() {
            const books = DataService.getTextbooks(activeSchoolType === 'high' ? 'high' : 'middle', currentGrade, activeSchoolId);
            const tbody = document.getElementById('textbook-table');
            
            if (isTextbookEditMode) {
                tbody.innerHTML = books.map((b, idx) => `
                    <tr class="bg-white border-b">
                        <td class="px-2 py-2"><input type="text" class="editable-input" value="${b.subject}" onchange="updateTextbookLocal(${idx}, 'subject', this.value)"></td>
                        <td class="px-2 py-2"><input type="text" class="editable-input" value="${b.pub}" onchange="updateTextbookLocal(${idx}, 'pub', this.value)"></td>
                        <td class="px-2 py-2"><input type="text" class="editable-input" value="${b.author}" onchange="updateTextbookLocal(${idx}, 'author', this.value)"></td>
                        <td class="px-2 py-2 text-center text-xs text-gray-400">편집중</td>
                        <td class="px-2 py-2 text-center"><button onclick="deleteTextbookRow(${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = books.length ? books.map(b => {
                    const badgeColor = b.status === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const badgeText = b.status === 'confirmed' ? '확인됨' : '추정';
                    return `
                    <tr class="bg-white border-b hover:bg-gray-50 fade-in">
                        <td class="px-4 py-3 font-medium text-gray-900 border-r border-gray-100">${b.subject}</td>
                        <td class="px-4 py-3 border-r border-gray-100">${b.pub}</td>
                        <td class="px-4 py-3 font-medium text-indigo-700 border-r border-gray-100">${b.author}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="${badgeColor} text-[10px] px-2 py-1 rounded-full font-bold">${badgeText}</span>
                        </td>
                        <td class="hidden"></td>
                    </tr>
                `}).join('') : '<tr><td colspan="5" class="text-center py-4 text-gray-400 text-xs">등록된 정보가 없습니다.</td></tr>';
            }
            lucide.createIcons();
        }
        function updateTextbookLocal(index, field, value) {
            const type = activeSchoolType === 'high' ? 'high' : 'middle';
            const data = DataService.getTextbooks(type, currentGrade, activeSchoolId);
            data[index][field] = value;
            DataService.saveTextbooks(type, currentGrade, data, activeSchoolId);
        }
        function addTextbookRow() {
            const type = activeSchoolType === 'high' ? 'high' : 'middle';
            const data = DataService.getTextbooks(type, currentGrade, activeSchoolId);
            data.push({ subject: '', pub: '', author: '', status: 'user-added' });
            DataService.saveTextbooks(type, currentGrade, data, activeSchoolId);
            renderTextbookTable();
        }
        function deleteTextbookRow(index) {
            const type = activeSchoolType === 'high' ? 'high' : 'middle';
            const data = DataService.getTextbooks(type, currentGrade, activeSchoolId);
            data.splice(index, 1);
            DataService.saveTextbooks(type, currentGrade, data, activeSchoolId);
            renderTextbookTable();
        }
        function toggleTextbookEditMode() { isTextbookEditMode = !isTextbookEditMode; updateTextbookEditUI(); renderTextbookTable(); }
        function updateTextbookEditUI() {
            const btn = document.getElementById('edit-textbook-btn');
            const addRowDiv = document.getElementById('add-textbook-row');
            const deleteCols = document.querySelectorAll('.edit-col');
            if (isTextbookEditMode) {
                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> 완료';
                btn.className = "text-xs px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium flex items-center gap-1 transition-colors";
                addRowDiv.classList.remove('hidden');
                deleteCols.forEach(c => c.classList.remove('hidden'));
            } else {
                btn.innerHTML = '<i data-lucide="settings" class="w-3 h-3"></i> 수정';
                btn.className = "text-xs px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium flex items-center gap-1 transition-colors";
                addRowDiv.classList.add('hidden');
                deleteCols.forEach(c => c.classList.add('hidden'));
            }
            lucide.createIcons();
        }
        function saveTextbooks() { toggleTextbookEditMode(); showToast("저장되었습니다."); }

        // Comm & Dev Logic
        function renderCommList() {
            const list = DataService.getComments(activeSchoolId, currentGrade);
            document.getElementById('comm-list').innerHTML = list.map(c => `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-1"><span class="font-bold text-xs text-indigo-900">${c.author}</span><span class="text-[10px] text-gray-400">${c.date}</span></div>
                    <p class="text-sm text-gray-700">${c.text}</p>
                </div>
            `).join('') || '<p class="text-center text-gray-400 text-xs py-4">글이 없습니다.</p>';
        }
        function addComment() {
            const author = document.getElementById('comm-author').value;
            const text = document.getElementById('comm-content').value;
            if (!author || !text) return showToast("내용을 입력하세요.");
            const now = new Date();
            DataService.addComment(activeSchoolId, currentGrade, { author, text, date: `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}` });
            document.getElementById('comm-content').value = '';
            renderCommList();
        }
        function renderDevRequests() {
            const list = DataService.getDevRequests();
            document.getElementById('dev-request-list').innerHTML = list.map(req => `<div class="bg-white p-3 rounded border border-gray-200 flex items-start gap-2"><i data-lucide="message-square" class="w-4 h-4 text-yellow-500 mt-0.5 flex-shrink-0"></i><p class="text-sm text-gray-700">${req.text}</p></div>`).join('') || '<p class="text-gray-400 text-xs italic">건의사항이 없습니다.</p>';
            lucide.createIcons();
        }
        function addDevRequest() {
            const input = document.getElementById('dev-request-input');
            if (!input.value) return;
            DataService.addDevRequest({ text: input.value });
            input.value = '';
            renderDevRequests();
            showToast("전송되었습니다.");
        }

        // General UI
        function updateGradeUI(grade) {
            currentGrade = parseInt(grade);
            gradeBtns.forEach(btn => {
                btn.className = parseInt(btn.dataset.grade) === currentGrade 
                    ? 'grade-btn flex-1 px-4 py-2 md:py-1.5 text-xs font-bold rounded-md bg-indigo-600 text-white shadow-sm transition-all' 
                    : 'grade-btn flex-1 px-4 py-2 md:py-1.5 text-xs font-medium text-gray-500 hover:bg-gray-50 rounded-md transition-all';
            });
        }
        gradeBtns.forEach(btn => btn.addEventListener('click', (e) => {
            updateGradeUI(e.target.dataset.grade);
            renderGradeContent(getAllSchools().find(s => s.id === activeSchoolId));
        }));

        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(btn => btn.addEventListener('click', (e) => {
            const tabName = e.target.dataset.tab;
            tabs.forEach(t => {
                t.className = t.dataset.tab === tabName 
                    ? 'tab-btn active whitespace-nowrap px-4 py-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600' 
                    : 'tab-btn whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700';
            });
            contents.forEach(c => c.classList.toggle('hidden', c.id !== `tab-${tabName}`));
        }));

        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.replace('bg-indigo-100', 'bg-gray-100');
                b.classList.replace('text-indigo-700', 'text-gray-600');
            });
            e.target.classList.replace('bg-gray-100', 'bg-indigo-100');
            e.target.classList.replace('text-gray-600', 'text-indigo-700');
            currentFilter = e.target.dataset.type;
            renderSchoolList();
        }));

        searchInput.addEventListener('input', renderSchoolList);

        function openConfirmModal(type, index) { deleteTarget = { type, index }; modal.classList.remove('hidden'); }
        function closeConfirmModal() { deleteTarget = null; modal.classList.add('hidden'); }
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (deleteTarget && deleteTarget.type === 'schedule') {
                const fullSchedule = DataService.getSchedule(activeSchoolId, currentGrade);
                if (currentSemester === 1) fullSchedule.sem1.splice(deleteTarget.index, 1); else fullSchedule.sem2.splice(deleteTarget.index, 1);
                DataService.saveSchedule(activeSchoolId, currentGrade, fullSchedule);
                renderScheduleList();
                showToast("삭제되었습니다.");
            } else if (deleteTarget && deleteTarget.type === 'textbook') {
                deleteTextbookRow(deleteTarget.index); // Re-route logic
                showToast("삭제되었습니다.");
            }
            closeConfirmModal();
        });

        function setSemester(sem) {
            currentSemester = sem;
            updateSemesterUI();
            renderScheduleList();
        }
        function updateSemesterUI() {
            document.getElementById('sem-1-btn').className = currentSemester === 1 ? 'semester-active flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center' : 'semester-inactive flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center';
            document.getElementById('sem-2-btn').className = currentSemester === 2 ? 'semester-active flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center' : 'semester-inactive flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center';
        }

        function updateClock() {
            const currentTimeEl = document.getElementById('current-time');
            if (!currentTimeEl) return;
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('ko-KR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg text-sm flex items-center gap-2 fade-in';
            toast.innerHTML = `<i data-lucide="bell-ring" class="w-4 h-4 text-yellow-400"></i> ${message}`;
            document.getElementById('toast-container').appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 4000);
        }
        
        window.copyLink = function() { showToast("링크가 복사되었습니다."); };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderSchoolList();
            loadSchool(defaultSchools[0].id);
        });

    </script>
</body>
</html>
