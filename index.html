<script>
        // Default Schools Data (교훈/슬로건 업데이트 완료)
        const defaultSchools = [
            { id: 'gajaewul', name: '가재울중학교', type: 'middle', students: '850명', transport: '경의중앙 가좌역', phone: '02-304-0070', website: 'http://gajaeul.sen.ms.kr', address: '서울특별시 서대문구 수색로 100-75', desc: '지성(至誠): 지극한 정성으로 최선을 다하자' },
            { id: 'gyeongseong_h', name: '경성고등학교', type: 'high', students: '720명', transport: '홍대입구역', phone: '02-335-2621', website: 'http://gyeongseong.sen.hs.kr', address: '서울특별시 마포구 성미산로 111', desc: '진실(眞實)·근면(勤勉)·협동(協同)' },
            { id: 'gyeongseong_m', name: '경성중학교', type: 'middle', students: '450명', transport: '홍대입구역', phone: '02-334-9171', website: 'http://gyeongseong.sen.ms.kr', address: '서울특별시 마포구 성미산로 111', desc: '배우며 생각하고 실천하는 사람' },
            { id: 'gwangseong', name: '광성고등학교', type: 'high', students: '800명', transport: '대흥역', phone: '02-713-6321', website: 'http://kwangsung.sen.hs.kr', address: '서울특별시 마포구 신수로8길 20', desc: '빛과 소금: 세상에 꼭 필요한 사람이 되자' },
            { id: 'duksung', name: '덕성여자고등학교', type: 'high', students: '650명', transport: '안국역', phone: '02-720-2161', website: 'http://duksung.sen.hs.kr', address: '서울특별시 종로구 율곡로3길 50', desc: '사랑·대화·봉사: 덕성을 갖춘 창의적 인재' },
            { id: 'dongdo', name: '동도중학교', type: 'middle', students: '600명', transport: '대흥역', phone: '02-715-2365', website: 'http://dong-do.sen.ms.kr', address: '서울특별시 마포구 백범로25길 41', desc: '효도(孝道)·애국(愛國)' },
            { id: 'seoul_w_m', name: '서울여자중학교', type: 'middle', students: '500명', transport: '마포구청역', phone: '02-715-6261', website: 'http://seoul.sen.ms.kr', address: '서울특별시 마포구 백범로25길 34', desc: '슬기롭고 아름답게' },
            { id: 'soongmoon', name: '숭문중학교', type: 'middle', students: '480명', transport: '대흥역', phone: '02-716-2971', website: 'http://soongmoon.sen.ms.kr', address: '서울특별시 마포구 숭문길 99', desc: '자율(自律)·협동(協同)·봉사(奉仕)' },
            { id: 'sindorim', name: '신도림중학교', type: 'middle', students: '900명', transport: '신도림역', phone: '02-2633-7011', website: 'http://sindorim.sen.ms.kr', address: '서울특별시 구로구 경인로63길 74', desc: '참되고 슬기롭게' },
            { id: 'ahyeon', name: '아현중학교', type: 'middle', students: '400명', transport: '아현역', phone: '02-362-6731', website: 'http://ahyeon.sen.ms.kr', address: '서울특별시 마포구 마포대로 247', desc: '성실(誠實): 바르게, 알차게, 굳세게' },
            { id: 'ewha_h', name: '이대부속고등학교', type: 'high', students: '1,100명', transport: '이대역', phone: '02-362-2246', website: 'http://edaebugo.sen.hs.kr', address: '서울특별시 서대문구 성산로 560', desc: '자유(自由)·사랑·평화(平和)' },
            { id: 'ewha_m', name: '이대부속중학교', type: 'middle', students: '550명', transport: '이대역', phone: '02-362-2242', website: 'http://ewha.sen.ms.kr', address: '서울특별시 서대문구 성산로 560', desc: '자유·사랑·평화: 100년을 이어온 배움터' },
            { id: 'inchang', name: '인창고등학교', type: 'high', students: '680명', transport: '서대문역', phone: '02-363-0161', website: 'http://inchang.sen.hs.kr', address: '서울특별시 서대문구 경기대로 65', desc: '인(仁)·의(義)·예(禮)·지(智)' },
            { id: 'jungang_h', name: '중앙여자고등학교', type: 'high', students: '700명', transport: '홍제역', phone: '02-362-3061', website: 'http://jungang.sen.hs.kr', address: '서울특별시 서대문구 북아현로11가길 7', desc: '참되고 착하고 아름다워라' },
            { id: 'jungang_m', name: '중앙여자중학교', type: 'middle', students: '450명', transport: '홍제역', phone: '02-362-3062', website: 'http://jungang.sen.ms.kr', address: '서울특별시 서대문구 북아현로11가길 7', desc: '참되고 착하고 아름다워라' },
            { id: 'changcheon', name: '창천중학교', type: 'middle', students: '350명', transport: '신촌역', phone: '02-701-0071', website: 'http://changcheon.sen.ms.kr', address: '서울특별시 마포구 백범로1길 56', desc: '바른 인성, 알찬 실력' },
            { id: 'hanseong', name: '한국한성화교중', type: 'middle', students: '200명', transport: '연희동', phone: '02-335-7027', website: 'http://hanxiao.or.kr', address: '서울특별시 서대문구 연희로 176', desc: '예의염치(禮義廉恥)' },
        ];

        // Auto-fill Database (Expanded)
        const autoFillDB = {
            '배문고': { type: 'high', address: '서울특별시 용산구 효창원로 258', website: 'http://www.baemoon.hs.kr', phone: '02-3480-7100' },
            '한성고': { type: 'high', address: '서울특별시 서대문구 북아현로1길 24', website: 'http://hanseong.sen.hs.kr', phone: '02-363-4943' },
            '숭실고': { type: 'high', address: '서울특별시 은평구 은평터널로7길 6', website: 'http://soongsil.sen.hs.kr', phone: '02-373-5910' },
            '용산고': { type: 'high', address: '서울특별시 용산구 두텁바위로 60', website: 'http://yongsan.sen.hs.kr', phone: '02-3706-6700' },
            '이화여고': { type: 'high', address: '서울특별시 중구 정동길 26', website: 'http://www.ewha.hs.kr', phone: '02-752-3353' },
            '배화여고': { type: 'high', address: '서울특별시 종로구 필운대로1길 34', website: 'http://paiwha.sen.hs.kr', phone: '02-724-0300' },
            '대신고': { type: 'high', address: '서울특별시 종로구 사직로 9', website: 'http://daeshin.sen.hs.kr', phone: '02-736-0317' },
            '명지고': { type: 'high', address: '서울특별시 서대문구 명지2길 56', website: 'http://myongji.sen.hs.kr', phone: '02-303-1540' },
            '충암고': { type: 'high', address: '서울특별시 은평구 가좌로5길 5', website: 'http://cham.sen.hs.kr', phone: '02-309-0236' },
            '가재울고': { type: 'high', address: '서울특별시 서대문구 수색로 100-35', website: 'http://gajaeul.sen.hs.kr', phone: '02-6351-0500' },
            '상암고': { type: 'high', address: '서울특별시 마포구 월드컵북로 445', website: 'http://sangam.sen.hs.kr', phone: '02-373-0041' },
            '홍익여고': { type: 'high', address: '서울특별시 마포구 성미산로 51', website: 'http://hongik.sen.hs.kr', phone: '02-331-7584' },
            '홍익디자인고': { type: 'high', address: '서울특별시 마포구 성미산로 111', website: 'http://hongik.sen.sc.kr', phone: '02-3140-1330' }
        };

        // Verified 2025 Textbook Data (Specific Schools)
        const textbookDataSeed = {
            'soongmoon': {
                 '1': [ 
                    { subject: '국어', pub: '비상(박현숙)', author: '박현숙', status: 'confirmed' }, 
                    { subject: '수학', pub: '비상(이진호)', author: '이진호', status: 'confirmed' }, 
                    { subject: '사회', pub: '비상(강창숙)', author: '강창숙', status: 'confirmed' }, 
                    { subject: '과학', pub: '비상(임태훈)', author: '임태훈', status: 'confirmed' },
                    { subject: '도덕', pub: '비상(김국현)', author: '김국현', status: 'confirmed' },
                    { subject: '체육', pub: '동아(최의창)', author: '최의창', status: 'confirmed' },
                    { subject: '미술', pub: '미래엔(노현옥)', author: '노현옥', status: 'confirmed' }
                ]
            },
            'gajaewul': { 
                 '1': [ 
                    { subject: '국어', pub: '비상(박현숙)', author: '박현숙', status: 'confirmed' }, 
                    { subject: '수학', pub: '비상(이진호)', author: '이진호', status: 'confirmed' }, 
                    { subject: '사회', pub: '비상(강창숙)', author: '강창숙', status: 'confirmed' }, 
                    { subject: '도덕', pub: '비상(김국현)', author: '김국현', status: 'confirmed' }
                ]
            },
            // General Fallback
            'middle': {
                '1': [ { subject: '국어', pub: '비상(박현숙)', author: '박현숙', status: 'estimated' }, { subject: '수학', pub: '비상(이진호)', author: '이진호', status: 'estimated' }, { subject: '영어', pub: '동아(윤정미)', author: '윤정미', status: 'estimated' }, { subject: '사회', pub: '비상(강창숙)', author: '강창숙', status: 'estimated' }, { subject: '과학', pub: '비상(임태훈)', author: '임태훈', status: 'estimated' } ],
                '2': [ { subject: '국어', pub: '천재(박영목)', author: '박영목', status: 'estimated' }, { subject: '수학', pub: '비상(김원경)', author: '김원경', status: 'estimated' }, { subject: '영어', pub: '동아(윤정미)', author: '윤정미', status: 'estimated' }, { subject: '역사', pub: '미래엔(김태웅)', author: '김태웅', status: 'estimated' }, { subject: '과학', pub: '미래엔(김성진)', author: '김성진', status: 'estimated' } ],
                '3': [ { subject: '국어', pub: '천재(박영목)', author: '박영목', status: 'estimated' }, { subject: '수학', pub: '비상(김원경)', author: '김원경', status: 'estimated' }, { subject: '영어', pub: '동아(윤정미)', author: '윤정미', status: 'estimated' }, { subject: '역사', pub: '비상(도면회)', author: '도면회', status: 'estimated' }, { subject: '과학', pub: '비상(임태훈)', author: '임태훈', status: 'estimated' } ]
            },
            'high': {
                '1': [ { subject: '공통국어', pub: '비상(박영민)', author: '박영민', status: 'estimated' }, { subject: '공통수학', pub: '비상(김원경)', author: '김원경', status: 'estimated' }, { subject: '영어', pub: '천재(이재영)', author: '이재영', status: 'estimated' }, { subject: '통합사회', pub: '비상(이영호)', author: '이영호', status: 'estimated' }, { subject: '통합과학', pub: '비상(심규철)', author: '심규철', status: 'estimated' } ],
                '2': [ { subject: '문학', pub: '비상(한철우)', author: '한철우', status: 'estimated' }, { subject: '수학I', pub: '미래엔(황선욱)', author: '황선욱', status: 'estimated' }, { subject: '영어I', pub: '능률(김성곤)', author: '김성곤', status: 'estimated' }, { subject: '세계지리', pub: '비상(최병천)', author: '최병천', status: 'estimated' } ],
                '3': [ { subject: '화법과작문', pub: '비상(박영민)', author: '박영민', status: 'estimated' }, { subject: '미적분', pub: '미래엔(황선욱)', author: '황선욱', status: 'estimated' }, { subject: '영어독해', pub: '비상(김진완)', author: '김진완', status: 'estimated' } ]
            }
        };
        
        const schoolExamSchedules = { 'default': { sem1: [], sem2: [] } };

        // Persistence Service
        const DataService = {
            getSchedule: function(schoolId, grade) {
                const key = `schedule_${schoolId}_${grade}`;
                const stored = localStorage.getItem(key);
                if (stored) return JSON.parse(stored);
                return { sem1: [], sem2: [] };
            },
            saveSchedule: function(schoolId, grade, data) {
                localStorage.setItem(`schedule_${schoolId}_${grade}`, JSON.stringify(data));
            },
            getTextbooks: function(schoolType, grade, schoolId) {
                const key = `textbook_${schoolId || schoolType}_${grade}`;
                const stored = localStorage.getItem(key);
                if (stored) return JSON.parse(stored);
                
                let seedData = [];
                if (schoolId && textbookDataSeed[schoolId] && textbookDataSeed[schoolId][grade]) {
                     seedData = textbookDataSeed[schoolId][grade];
                } else {
                     seedData = textbookDataSeed[schoolType][grade] || [];
                }
                
                localStorage.setItem(key, JSON.stringify(seedData));
                return seedData;
            },
            saveTextbooks: function(schoolType, grade, data, schoolId) {
                const key = `textbook_${schoolId || schoolType}_${grade}`;
                localStorage.setItem(key, JSON.stringify(data));
            },
            getComments: function(schoolId, grade) {
                const stored = localStorage.getItem(`comm_${schoolId}_${grade}`);
                return stored ? JSON.parse(stored) : [];
            },
            addComment: function(schoolId, grade, comment) {
                const list = this.getComments(schoolId, grade);
                list.unshift(comment);
                localStorage.setItem(`comm_${schoolId}_${grade}`, JSON.stringify(list));
                return list;
            },
            getDevRequests: function() {
                const stored = localStorage.getItem('dev_requests');
                return stored ? JSON.parse(stored) : [];
            },
            addDevRequest: function(req) {
                const list = this.getDevRequests();
                list.unshift(req);
                localStorage.setItem('dev_requests', JSON.stringify(list));
                return list;
            },
            getWebsite: function(schoolId) {
                return localStorage.getItem(`website_${schoolId}`);
            },
            saveWebsite: function(schoolId, url) {
                localStorage.setItem(`website_${schoolId}`, url);
            },
            getCustomSchools: function() {
                const stored = localStorage.getItem('custom_schools');
                return stored ? JSON.parse(stored) : [];
            },
            addCustomSchool: function(school) {
                const list = this.getCustomSchools();
                list.push(school);
                localStorage.setItem('custom_schools', JSON.stringify(list));
                return list;
            }
        };

        // Helper to merge default and custom schools
        function getAllSchools() {
            const custom = DataService.getCustomSchools();
            return [...defaultSchools, ...custom];
        }

        // State
        let currentFilter = 'all';
        let activeSchoolId = defaultSchools[0].id;
        let activeSchoolType = defaultSchools[0].type;
        let currentGrade = 1;
        let currentSemester = 2;
        let isTextbookEditMode = false;
        let deleteTarget = null;
        let addSchoolType = 'middle'; 
        let autoFillData = null;

        // Elements
        const schoolListEl = document.getElementById('school-list');
        const searchInput = document.getElementById('school-search');
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('mobile-backdrop');
        const mobileMenuBtn = document.getElementById('menu-toggle');
        const currentTimeEl = document.getElementById('current-time'); 
        const gradeBtns = document.querySelectorAll('.grade-btn');
        const modal = document.getElementById('confirm-modal');
        const addSchoolModal = document.getElementById('add-school-modal');
        const settingsModal = document.getElementById('settings-modal');

        // Sidebar Logic
        function closeSidebar() { sidebar.classList.add('-translate-x-full'); backdrop.classList.add('hidden'); }
        function openSidebar() { sidebar.classList.remove('-translate-x-full'); backdrop.classList.remove('hidden'); }
        mobileMenuBtn.addEventListener('click', openSidebar);

        function openExternalLink(url) {
            if (!url) return;
            window.open(url, '_blank', 'noopener,noreferrer');
        }
        
        function searchTextbookInfo() {
             const schoolName = document.getElementById('school-name').textContent;
             const query = schoolName + ' 2025학년도 교과서 목록';
             openExternalLink('https://www.google.com/search?q=' + encodeURIComponent(query));
        }
        
        // Render School List
        function renderSchoolList() {
            schoolListEl.innerHTML = '';
            const query = searchInput.value.toLowerCase();
            const allSchools = getAllSchools();
            
            const filtered = allSchools.filter(school => {
                const matchType = currentFilter === 'all' || school.type === currentFilter;
                const matchSearch = school.name.toLowerCase().includes(query);
                return matchType && matchSearch;
            });

            if (filtered.length === 0 && query) {
                schoolListEl.innerHTML = `
                    <div class="p-4 text-center">
                        <p class="text-sm text-gray-500 mb-3">'${query}' 검색 결과가 없습니다.</p>
                        <button onclick="openAddSchoolModal('${query}')" class="w-full py-2 bg-indigo-50 text-indigo-700 rounded-lg text-sm font-bold border border-indigo-100 hover:bg-indigo-100">
                            '${query}' 직접 추가하기
                        </button>
                    </div>
                `;
            } else {
                filtered.forEach(school => {
                    const isActive = school.id === activeSchoolId;
                    const item = document.createElement('button');
                    item.className = `w-full text-left p-3 rounded-lg transition mb-1 flex items-center justify-between group ${isActive ? 'school-item-active' : 'school-item-inactive'}`;
                    item.onclick = () => loadSchool(school.id);
                    item.innerHTML = `
                        <div class="overflow-hidden">
                            <div class="font-medium text-sm ${isActive ? 'text-indigo-700' : 'text-gray-700'} truncate">${school.name}</div>
                            <div class="text-xs text-gray-400 truncate max-w-[200px]">${school.address || '주소 미입력'}</div>
                        </div>
                        <i data-lucide="chevron-right" class="w-4 h-4 text-gray-300 ${isActive ? 'text-indigo-500' : 'group-hover:text-gray-400'} flex-shrink-0"></i>
                    `;
                    schoolListEl.appendChild(item);
                });
            }
            lucide.createIcons();
        }

        function loadSchool(id) {
            activeSchoolId = id;
            const allSchools = getAllSchools();
            const data = allSchools.find(s => s.id === id);
            if(!data) return;
            activeSchoolType = data.type;
            renderSchoolList();

            document.getElementById('school-name').textContent = data.name;
            document.getElementById('school-desc').textContent = data.desc || '꿈과 끼를 키우는 행복한 배움터'; // 교훈 업데이트 로직 추가
            document.getElementById('school-badge').textContent = data.type === 'high' ? '고등학교' : '중학교';
            document.getElementById('school-badge').className = `px-2 py-0.5 rounded text-xs font-bold ${data.type === 'high' ? 'bg-blue-100 text-blue-700' : 'bg-green-100 text-green-700'}`;
            document.getElementById('student-count').textContent = data.students || '정보 없음';
            document.getElementById('transport-info').textContent = data.transport || '-';
            document.getElementById('phone-link').textContent = data.phone || '-';
            document.getElementById('phone-link').href = data.phone ? `tel:${data.phone}` : '#';
            
            const userUrl = DataService.getWebsite(activeSchoolId);
            const finalUrl = userUrl || data.website;
            
            const addr = data.address || '주소 정보가 없습니다';
            const mapQuery = `https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(addr)}`;
            
            const mapHandler = (e) => { e.preventDefault(); openExternalLink(mapQuery); };
            document.getElementById('header-map-link').onclick = mapHandler;
            document.getElementById('sidebar-map-link').onclick = mapHandler;
            
            document.getElementById('school-address-header').textContent = addr;
            document.getElementById('map-address-text').textContent = addr;

            if(window.innerWidth < 768) closeSidebar();

            updateGradeUI(1);
            currentSemester = 2;
            updateSemesterUI();
            isTextbookEditMode = false;
            updateTextbookEditUI();
            
            const webHandler = (e) => { e.preventDefault(); openExternalLink(finalUrl); };
            document.getElementById('school-website-link').onclick = webHandler;
            document.getElementById('website-edit-form').classList.add('hidden');

            // Update link in academic tab
            document.getElementById('btn-homepage-schedule').onclick = webHandler;

            renderGradeContent(data);
            document.getElementById('mobile-header-title').textContent = data.name;
        }

        function renderGradeContent(data) {
            document.querySelectorAll('.current-grade-text').forEach(el => el.textContent = `${currentGrade}학년`);
            renderScheduleList();
            renderTextbookTable();
            renderCommList();
            renderDevRequests();
            renderNewsList();
            lucide.createIcons();
        }

        // --- Settings Modal ---
        function openSettings() {
            settingsModal.classList.remove('hidden');
        }
        function closeSettings() { settingsModal.classList.add('hidden'); }

        // --- Add School Modal Logic ---
        function openAddSchoolModal(prefillName = '') {
            document.getElementById('add-school-name').value = prefillName;
            document.getElementById('add-school-addr').value = '';
            document.getElementById('add-school-web').value = '';
            document.getElementById('auto-fill-msg').classList.add('hidden');
            autoFillData = null;
            if(prefillName) handleSchoolNameInput(prefillName);
            addSchoolType = 'middle'; 
            selectAddType('middle');
            addSchoolModal.classList.remove('hidden');
        }
        function closeAddSchoolModal() { addSchoolModal.classList.add('hidden'); }

        function handleSchoolNameInput(val) {
            const trimmed = val.trim();
            let foundKey = Object.keys(autoFillDB).find(key => trimmed.includes(key));
            if (foundKey) {
                const info = autoFillDB[foundKey];
                document.getElementById('add-school-addr').value = info.address;
                document.getElementById('add-school-web').value = info.website;
                selectAddType(info.type);
                document.getElementById('auto-fill-msg').classList.remove('hidden');
                autoFillData = info;
            } else {
                document.getElementById('auto-fill-msg').classList.add('hidden');
                autoFillData = null;
            }
        }

        function selectAddType(type) {
            addSchoolType = type;
            const btnMid = document.getElementById('btn-type-middle');
            const btnHigh = document.getElementById('btn-type-high');
            if(type === 'middle') {
                btnMid.className = "flex-1 py-2 border rounded-lg text-sm bg-indigo-50 border-indigo-500 text-indigo-700 font-bold";
                btnHigh.className = "flex-1 py-2 border rounded-lg text-sm border-gray-300 text-gray-600 hover:bg-gray-50";
            } else {
                btnHigh.className = "flex-1 py-2 border rounded-lg text-sm bg-blue-50 border-blue-500 text-blue-700 font-bold";
                btnMid.className = "flex-1 py-2 border rounded-lg text-sm border-gray-300 text-gray-600 hover:bg-gray-50";
            }
        }
        
        function submitAddSchool() {
            const name = document.getElementById('add-school-name').value.trim();
            const addr = document.getElementById('add-school-addr').value.trim();
            const web = document.getElementById('add-school-web').value.trim();
            
            if(!name) return showToast("학교명을 입력해주세요.");
            
            const newSchool = {
                id: `custom_${Date.now()}`,
                name: name,
                type: addSchoolType,
                address: addr || '주소 미입력',
                website: web || '',
                students: '정보 없음',
                transport: '-',
                phone: autoFillData ? autoFillData.phone : '-',
                desc: '직접 추가한 학교입니다.'
            };
            
            DataService.addCustomSchool(newSchool);
            closeAddSchoolModal();
            showToast("학교가 추가되었습니다.");
            document.getElementById('school-search').value = '';
            renderSchoolList();
            loadSchool(newSchool.id);
        }

        // Website Edit Logic
        function editWebsite() {
            const currentUrl = DataService.getWebsite(activeSchoolId) || getAllSchools().find(s => s.id === activeSchoolId)?.website;
            document.getElementById('new-website-url').value = currentUrl || '';
            document.getElementById('website-edit-form').classList.remove('hidden');
        }
        function cancelEditWebsite() { document.getElementById('website-edit-form').classList.add('hidden'); }
        function saveWebsite() {
            const newUrl = document.getElementById('new-website-url').value;
            if(newUrl) {
                DataService.saveWebsite(activeSchoolId, newUrl);
                document.getElementById('school-website-link').onclick = (e) => { e.preventDefault(); openExternalLink(newUrl); };
                showToast("홈페이지 주소가 수정되었습니다.");
                cancelEditWebsite();
            }
        }

        // News Logic - Keywords
        function renderNewsList() {
            const newsEl = document.getElementById('news-list');
            document.getElementById('news-date').textContent = new Date().toLocaleDateString() + " 기준";
            
            const keywords = [
                { word: "2028 대입 개편", query: "2028 대입 개편" },
                { word: "의대 증원", query: "의대 증원" },
                { word: "고교학점제", query: "고교학점제" },
                { word: "수능 킬러문항", query: "수능 킬러문항" },
                { word: "특목고/자사고", query: "특목고 자사고" },
                { word: "2026 수시", query: "2026 수시" },
                { word: "디지털 교과서", query: "디지털 교과서" }
            ];

            newsEl.innerHTML = `
                <div class="flex flex-wrap gap-2">
                    ${keywords.map(k => `
                        <button onclick="openExternalLink('http://www.veritas-a.com/news/articleList.html?sc_word=${encodeURIComponent(k.query)}')" 
                            class="px-3 py-1.5 bg-indigo-50 text-indigo-700 text-xs font-bold rounded-full border border-indigo-100 hover:bg-indigo-100 hover:border-indigo-300 transition-colors">
                            #${k.word}
                        </button>
                    `).join('')}
                </div>
            `;
        }

        // Schedule Logic
        function renderScheduleList() {
            const fullSchedule = DataService.getSchedule(activeSchoolId, currentGrade);
            const activeSchedule = currentSemester === 1 ? fullSchedule.sem1 : fullSchedule.sem2;
            document.getElementById('schedule-list').innerHTML = activeSchedule.map((s, index) => `
                <div class="relative pl-6 fade-in group flex justify-between items-start">
                    <div class="absolute left-[-5px] top-1 w-2.5 h-2.5 bg-indigo-600 rounded-full border-2 border-white"></div>
                    <div><p class="text-xs font-bold text-indigo-600">${s.date}</p><p class="text-sm text-gray-800">${s.event}</p></div>
                    <button onclick="openConfirmModal('schedule', ${index})" class="text-gray-400 hover:text-red-500 p-1"><i data-lucide="x" class="w-4 h-4"></i></button>
                </div>
            `).join('') || '<p class="text-gray-400 text-sm italic ml-4">등록된 일정이 없습니다.</p>';
            lucide.createIcons();
        }
        function addSchedule() {
            const dateInput = document.getElementById('new-sched-date');
            const eventInput = document.getElementById('new-sched-event');
            if (!dateInput.value || !eventInput.value) return showToast("내용을 입력하세요.");
            const fullSchedule = DataService.getSchedule(activeSchoolId, currentGrade);
            const newItem = { date: dateInput.value, event: eventInput.value };
            if (currentSemester === 1) fullSchedule.sem1.push(newItem); else fullSchedule.sem2.push(newItem);
            
            const dateValue = (d) => { const parts = d.date.split('~')[0].trim().replace(/<[^>]*>/g, '').split('/'); return parseInt(parts[0]) * 100 + parseInt(parts[1]); };
            if(currentSemester === 1) fullSchedule.sem1.sort((a,b) => dateValue(a) - dateValue(b)); else fullSchedule.sem2.sort((a,b) => dateValue(a) - dateValue(b));
            
            DataService.saveSchedule(activeSchoolId, currentGrade, fullSchedule);
            renderScheduleList();
            dateInput.value = ''; eventInput.value = '';
            showToast("추가되었습니다.");
        }

        // Textbook Logic (Enhanced)
        function renderTextbookTable() {
            const books = DataService.getTextbooks(activeSchoolType === 'high' ? 'high' : 'middle', currentGrade, activeSchoolId);
            const tbody = document.getElementById('textbook-table');
            
            if (isTextbookEditMode) {
                tbody.innerHTML = books.map((b, idx) => `
                    <tr class="bg-white border-b">
                        <td class="px-2 py-2"><input type="text" class="editable-input" value="${b.subject}" onchange="updateTextbookLocal(${idx}, 'subject', this.value)"></td>
                        <td class="px-2 py-2"><input type="text" class="editable-input" value="${b.pub}" onchange="updateTextbookLocal(${idx}, 'pub', this.value)"></td>
                        <td class="px-2 py-2"><input type="text" class="editable-input" value="${b.author}" onchange="updateTextbookLocal(${idx}, 'author', this.value)"></td>
                        <td class="px-2 py-2 text-center text-xs text-gray-400">편집중</td>
                        <td class="px-2 py-2 text-center"><button onclick="deleteTextbookRow(${idx})" class="text-red-500 hover:bg-red-50 p-1 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></td>
                    </tr>
                `).join('');
            } else {
                tbody.innerHTML = books.length ? books.map(b => {
                    const badgeColor = b.status === 'confirmed' ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800';
                    const badgeText = b.status === 'confirmed' ? '확인됨' : '추정';
                    return `
                    <tr class="bg-white border-b hover:bg-gray-50 fade-in">
                        <td class="px-4 py-3 font-medium text-gray-900 border-r border-gray-100">${b.subject}</td>
                        <td class="px-4 py-3 border-r border-gray-100">${b.pub}</td>
                        <td class="px-4 py-3 font-medium text-indigo-700 border-r border-gray-100">${b.author}</td>
                        <td class="px-4 py-3 text-center">
                            <span class="${badgeColor} text-[10px] px-2 py-1 rounded-full font-bold">${badgeText}</span>
                        </td>
                        <td class="hidden"></td>
                    </tr>
                `}).join('') : '<tr><td colspan="5" class="text-center py-4 text-gray-400 text-xs">등록된 정보가 없습니다.</td></tr>';
            }
            lucide.createIcons();
        }
        function updateTextbookLocal(index, field, value) {
            const type = activeSchoolType === 'high' ? 'high' : 'middle';
            const data = DataService.getTextbooks(type, currentGrade, activeSchoolId);
            data[index][field] = value;
            DataService.saveTextbooks(type, currentGrade, data, activeSchoolId);
        }
        function addTextbookRow() {
            const type = activeSchoolType === 'high' ? 'high' : 'middle';
            const data = DataService.getTextbooks(type, currentGrade, activeSchoolId);
            data.push({ subject: '', pub: '', author: '', status: 'user-added' });
            DataService.saveTextbooks(type, currentGrade, data, activeSchoolId);
            renderTextbookTable();
        }
        function deleteTextbookRow(index) {
            const type = activeSchoolType === 'high' ? 'high' : 'middle';
            const data = DataService.getTextbooks(type, currentGrade, activeSchoolId);
            data.splice(index, 1);
            DataService.saveTextbooks(type, currentGrade, data, activeSchoolId);
            renderTextbookTable();
        }
        function toggleTextbookEditMode() { isTextbookEditMode = !isTextbookEditMode; updateTextbookEditUI(); renderTextbookTable(); }
        function updateTextbookEditUI() {
            const btn = document.getElementById('edit-textbook-btn');
            const addRowDiv = document.getElementById('add-textbook-row');
            const deleteCols = document.querySelectorAll('.edit-col');
            if (isTextbookEditMode) {
                btn.innerHTML = '<i data-lucide="check" class="w-3 h-3"></i> 완료';
                btn.className = "text-xs px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg font-medium flex items-center gap-1 transition-colors";
                addRowDiv.classList.remove('hidden');
                deleteCols.forEach(c => c.classList.remove('hidden'));
            } else {
                btn.innerHTML = '<i data-lucide="settings" class="w-3 h-3"></i> 수정';
                btn.className = "text-xs px-3 py-2 bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-lg font-medium flex items-center gap-1 transition-colors";
                addRowDiv.classList.add('hidden');
                deleteCols.forEach(c => c.classList.add('hidden'));
            }
            lucide.createIcons();
        }
        function saveTextbooks() { toggleTextbookEditMode(); showToast("저장되었습니다."); }

        // Comm & Dev Logic
        function renderCommList() {
            const list = DataService.getComments(activeSchoolId, currentGrade);
            document.getElementById('comm-list').innerHTML = list.map(c => `
                <div class="bg-white p-3 rounded-lg shadow-sm border border-gray-100">
                    <div class="flex justify-between items-center mb-1"><span class="font-bold text-xs text-indigo-900">${c.author}</span><span class="text-[10px] text-gray-400">${c.date}</span></div>
                    <p class="text-sm text-gray-700">${c.text}</p>
                </div>
            `).join('') || '<p class="text-center text-gray-400 text-xs py-4">글이 없습니다.</p>';
        }
        function addComment() {
            const author = document.getElementById('comm-author').value;
            const text = document.getElementById('comm-content').value;
            if (!author || !text) return showToast("내용을 입력하세요.");
            const now = new Date();
            DataService.addComment(activeSchoolId, currentGrade, { author, text, date: `${now.getMonth()+1}/${now.getDate()} ${now.getHours()}:${now.getMinutes()}` });
            document.getElementById('comm-content').value = '';
            renderCommList();
        }
        function renderDevRequests() {
            const list = DataService.getDevRequests();
            document.getElementById('dev-request-list').innerHTML = list.map(req => `<div class="bg-white p-3 rounded border border-gray-200 flex items-start gap-2"><i data-lucide="message-square" class="w-4 h-4 text-yellow-500 mt-0.5 flex-shrink-0"></i><p class="text-sm text-gray-700">${req.text}</p></div>`).join('') || '<p class="text-gray-400 text-xs italic">건의사항이 없습니다.</p>';
            lucide.createIcons();
        }
        function addDevRequest() {
            const input = document.getElementById('dev-request-input');
            if (!input.value) return;
            DataService.addDevRequest({ text: input.value });
            input.value = '';
            renderDevRequests();
            showToast("전송되었습니다.");
        }

        // General UI
        function updateGradeUI(grade) {
            currentGrade = parseInt(grade);
            gradeBtns.forEach(btn => {
                btn.className = parseInt(btn.dataset.grade) === currentGrade 
                    ? 'grade-btn flex-1 px-4 py-2 md:py-1.5 text-xs font-bold rounded-md bg-indigo-600 text-white shadow-sm transition-all' 
                    : 'grade-btn flex-1 px-4 py-2 md:py-1.5 text-xs font-medium text-gray-500 hover:bg-gray-50 rounded-md transition-all';
            });
        }
        gradeBtns.forEach(btn => btn.addEventListener('click', (e) => {
            updateGradeUI(e.target.dataset.grade);
            renderGradeContent(getAllSchools().find(s => s.id === activeSchoolId));
        }));

        const tabs = document.querySelectorAll('.tab-btn');
        const contents = document.querySelectorAll('.tab-content');
        tabs.forEach(btn => btn.addEventListener('click', (e) => {
            const tabName = e.target.dataset.tab;
            tabs.forEach(t => {
                t.className = t.dataset.tab === tabName 
                    ? 'tab-btn active whitespace-nowrap px-4 py-3 text-sm font-medium text-indigo-600 border-b-2 border-indigo-600' 
                    : 'tab-btn whitespace-nowrap px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700';
            });
            contents.forEach(c => c.classList.toggle('hidden', c.id !== `tab-${tabName}`));
        }));

        document.querySelectorAll('.filter-btn').forEach(btn => btn.addEventListener('click', (e) => {
            document.querySelectorAll('.filter-btn').forEach(b => {
                b.classList.replace('bg-indigo-100', 'bg-gray-100');
                b.classList.replace('text-indigo-700', 'text-gray-600');
            });
            e.target.classList.replace('bg-gray-100', 'bg-indigo-100');
            e.target.classList.replace('text-gray-600', 'text-indigo-700');
            currentFilter = e.target.dataset.type;
            renderSchoolList();
        }));

        searchInput.addEventListener('input', renderSchoolList);

        function openConfirmModal(type, index) { deleteTarget = { type, index }; modal.classList.remove('hidden'); }
        function closeConfirmModal() { deleteTarget = null; modal.classList.add('hidden'); }
        document.getElementById('confirm-delete-btn').addEventListener('click', () => {
            if (deleteTarget && deleteTarget.type === 'schedule') {
                const fullSchedule = DataService.getSchedule(activeSchoolId, currentGrade);
                if (currentSemester === 1) fullSchedule.sem1.splice(deleteTarget.index, 1); else fullSchedule.sem2.splice(deleteTarget.index, 1);
                DataService.saveSchedule(activeSchoolId, currentGrade, fullSchedule);
                renderScheduleList();
                showToast("삭제되었습니다.");
            } else if (deleteTarget && deleteTarget.type === 'textbook') {
                deleteTextbookRow(deleteTarget.index); // Re-route logic
                showToast("삭제되었습니다.");
            }
            closeConfirmModal();
        });

        function setSemester(sem) {
            currentSemester = sem;
            updateSemesterUI();
            renderScheduleList();
        }
        function updateSemesterUI() {
            document.getElementById('sem-1-btn').className = currentSemester === 1 ? 'semester-active flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center' : 'semester-inactive flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center';
            document.getElementById('sem-2-btn').className = currentSemester === 2 ? 'semester-active flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center' : 'semester-inactive flex-1 md:flex-none px-3 py-2 md:py-1 rounded-md transition-all text-center';
        }

        function updateClock() {
            const currentTimeEl = document.getElementById('current-time');
            if (!currentTimeEl) return;
            const now = new Date();
            currentTimeEl.textContent = now.toLocaleTimeString('ko-KR');
        }
        setInterval(updateClock, 1000);
        updateClock();

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'bg-gray-900 text-white px-4 py-3 rounded-lg shadow-lg text-sm flex items-center gap-2 fade-in';
            toast.innerHTML = `<i data-lucide="bell-ring" class="w-4 h-4 text-yellow-400"></i> ${message}`;
            document.getElementById('toast-container').appendChild(toast);
            lucide.createIcons();
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 500); }, 4000);
        }
        
        window.copyLink = function() { showToast("링크가 복사되었습니다."); };

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            renderSchoolList();
            loadSchool(defaultSchools[0].id);
        });

    </script>
